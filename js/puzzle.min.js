!function(n){n.fn.puzzle=function(e){var o={__rows:4,__columns:4};return this.each(function(){e&&n.extend(o,e);var t=this,i=0,r=0,s=new Array,a=0,l=o.__rows*o.__columns,c=new Array,u=new Array;n(window).load(function(){p(),b(),k(),I()});var p=function(){var e=0;n(t).children("IMG").each(function(){s[e]=n(this).attr("src"),e++}),r=n(t).children("IMG").width()-2*o.__rows,i=n(t).children("IMG").height()-2*o.__columns,n(t).children("IMG").remove(),d(),C()},d=function(){for(var e=1,t=0,i=0,r=1;r<=o.__columns;r++){for(var s=1;s<=o.__rows;s++)u[e]=e,h(e,t,i,_(),w(),a),i+=w(),e++;t+=_(),i=0}n("div[class=puzzleimage]:last").remove()},h=function(e,o,i,r,s,a){n(t).append("<div class='puzzleblock"+e+"' id='puzzleblock-"+e+"'></div>"),n(".puzzleblock"+e).css({"margin-left":""+i+"px","margin-top":""+o+"px",height:""+r+"px",width:""+s+"px",background:"#fff",border:"solid 1px #CCCCCC",position:"absolute","z-index":"100"}),g(".puzzleblock"+e,e),f(".puzzleblock"+e,e,o,i,r,s,a),n(".puzzleblock"+e).attr("class","puzzleblock")},f=function(e,o,t,i,r,a,l){n(e).append("<div class='puzzleimage"+o+"' id='"+o+"'></div>"),n(".puzzleimage"+o).css({height:""+r+"px",width:""+a+"px",background:"URL("+s[l]+")",border:"solid 1px #000","background-position":"-"+i+"px -"+t+"px",position:"absolute","z-index":"200"}),z(".puzzleimage"+o,o,i,t),n(".puzzleimage"+o).attr("class","puzzleimage")},_=function(){return Math.ceil(parseInt(i)/o.__columns)},w=function(){return Math.ceil(parseInt(r)/o.__rows)},z=function(e,t,i,r){n(e).bind({mouseenter:function(){n(this).css({"background-position":"-"+(i-2*o.__rows)+"px -"+(r-2*o.__columns)+"px","margin-left":"-"+2*o.__rows+"px","margin-top":"-"+2*o.__columns+"px",width:""+(w()+12),height:""+(_()+12),"box-shadow":" 0 0 2em #CC00FF","-webkit-box-shadow":"0 0 2em #CC00FF","-moz-box-shadow":"0 0 2em #CC00FF","z-index":"300"})},mouseleave:function(){n(this).css({"background-position":"-"+i+"px -"+r+"px","margin-left":"0px","margin-top":"0px",width:""+w(),height:""+_(),border:"solid 1px #000000","box-shadow":"none","-webkit-box-shadow":"none","-moz-box-shadow":"none","z-index":"300"})},click:function(){var e=n(this).parent("div").attr("id").split("-");1==x(parseInt(e[1]),c)&&(n(this).fadeOut("fast"),m(this,i,r),l=parseInt(e[1]),b(),I())}})},g=function(e,o){n(e).bind({mouseenter:function(e){e.preventDefault(),n(this).css({background:"#f3f3f3","z-index":"300"})},mouseleave:function(e){e.preventDefault(),n(this).css({background:"#FFF","z-index":"150"})},click:function(n){n.preventDefault()}})},b=function(){l%o.__rows==0?(c=new Array,c[0]=parseInt(l)-1,c[1]=parseInt(l)-o.__rows,c[2]=parseInt(l)+o.__rows):l%o.__rows==1?(c=new Array,c[0]=parseInt(l)+1,c[1]=parseInt(l)-o.__rows,c[2]=parseInt(l)+o.__rows):(c=new Array,c[0]=parseInt(l)+1,c[1]=parseInt(l)-1,c[2]=parseInt(l)-o.__rows,c[3]=parseInt(l)+o.__rows)},m=function(e,o,t){n(e).appendTo(n("#puzzleblock-"+l)),n(e).fadeIn("fast"),n(e).css({"background-position":"-"+o+"px -"+t+"px","margin-left":"0px","margin-top":"0px",width:""+w(),height:""+_(),border:"solid 1px #000000","box-shadow":"none","-webkit-box-shadow":"none","-moz-box-shadow":"none","z-index":"200"})},x=function(n,e){for(var o=!1,t=0;t<e.length;t++)if(e[t]==parseInt(n)){return!0;var o}else if(t==e.length-1&&!o&&e[t]!=parseInt(n))return!1},v=function(n,e){if(n>e.length)return!1;for(var o=new Array,t=e,i=0;n>i;i++){o[o.length]=t[Math.round((t.length-1)*Math.random())];for(var r=o[o.length-1],s=0;s<t.length;s++)if(t[s]==r){t[s]=null;for(var a=new Array,l=0;l<t.length;l++)null!=t[l]&&(a[a.length]=t[l]);t=a;break}}return o},k=function(){for(var e=v(o.__rows*o.__columns,u),t=0,i=0;i<e.length;i++)0==i?(n("#puzzleblock-"+e[i]).children().appendTo(n("#puzzleblock-"+o.__rows*o.__columns)),t=e[i]):(n("#puzzleblock-"+e[i]).children().appendTo(n("#puzzleblock-"+t)),t=e[i]);l=t,b()},I=function(){var e=0;n(".puzzleblock").each(function(){var t=this.getAttribute("id").split("-"),i=t[1],r=n(this).children(".puzzleimage").attr("id");parseInt(i)==parseInt(r)&&(e++,e==parseInt(o.__rows*o.__columns-1)&&(A(),s.length==a+1?a=0:a++,F()))})},C=function(){n("#preview").bind({mouseenter:function(n){n.preventDefault(),M()},mouseleave:function(n){n.preventDefault(),y()}})},M=function(){n(t).append("<div id='imageprivew'></div>"),n("#imageprivew").css({height:""+(i+Math.ceil(o.__rows/2)),width:""+(r+Math.ceil(o.__columns/2)),background:"URL("+s[a]+")",position:"absolute","z-index":"500"}).hide(),n("#imageprivew").slideDown()},y=function(){n("#imageprivew").slideUp(function(){},function(){n(this).remove()})},A=function(){n(t).children("DIV").remove()},F=function(){n(t).append("<div id='thanks'></div>"),n("#thanks").css({height:""+(i+Math.ceil(o.__rows/2)),width:""+(r+Math.ceil(o.__columns/2)),background:"URL("+s[a]+")",position:"absolute","z-index":"500"}).hide(),n("#thanks").slideDown(function(){d(),b(),k()}),n("#thanks").delay(2e3).slideUp()}})}}(jQuery);